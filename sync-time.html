<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncLink - Common Time Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .timeline-container {
            touch-action: none;
            user-select: none;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
        @keyframes bounce-subtle {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -10px); }
        }
        .animate-success {
            animation: bounce-subtle 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen p-4 md:p-8">

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden">
        <div class="bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-2 border border-emerald-400">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <span class="font-bold text-sm">Invite Copied & Calendar File Saved!</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2.5 rounded-xl text-white">
                    <i data-lucide="clock" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">SyncLink</h1>
                    <p class="text-slate-500 text-sm">Find the perfect time to meet across borders.</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                <i data-lucide="calendar" class="ml-2 text-slate-400 w-4 h-4"></i>
                <input type="date" id="datePicker" class="bg-transparent border-none focus:ring-0 text-sm font-bold px-3 py-1 cursor-pointer outline-none">
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- My Settings -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-2 mb-4 text-indigo-600 font-semibold uppercase text-xs tracking-wider">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Your Details</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Your Timezone</label>
                        <div class="relative">
                            <i data-lucide="globe" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            <select id="myTz" class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none appearance-none focus:ring-2 focus:ring-indigo-500/20"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1.5">
                            <i data-lucide="settings-2" class="w-3.5 h-3.5 text-slate-400"></i>
                            Your Working Hours
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="myWorkStart" class="bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                            <select id="myWorkEnd" class="bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Their Settings -->
            <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-2 mb-4 text-emerald-600 font-semibold uppercase text-xs tracking-wider">
                    <i data-lucide="globe" class="w-4 h-4"></i>
                    <span>Participant Details</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Their Timezone</label>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            <select id="otherTz" class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none appearance-none focus:ring-2 focus:ring-emerald-500/20"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1.5">
                            <i data-lucide="settings-2" class="w-3.5 h-3.5 text-slate-400"></i>
                            Their Working Hours
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="otherWorkStart" class="bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                            <select id="otherWorkEnd" class="bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Visual Timeline -->
        <section class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <i data-lucide="arrow-right-left" class="text-indigo-600 w-5 h-5"></i>
                    Availability Timeline
                </h2>
                <div class="flex flex-wrap gap-4 text-[10px] font-bold uppercase tracking-wider text-slate-500">
                    <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-indigo-500/20 border border-indigo-200"></div><span>You</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-emerald-500/20 border border-emerald-200"></div><span>Them</span></div>
                    <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-amber-400"></div><span>Overlap</span></div>
                </div>
            </div>

            <div id="timeline" class="timeline-container relative h-40 bg-slate-100 rounded-xl mb-6 cursor-crosshair border border-slate-200 shadow-inner overflow-visible">
                <!-- Hour segments and availability will be injected here -->
                <div id="timelineGrid" class="absolute inset-0 flex"></div>
                <!-- Selection overlay -->
                <div id="selectionCursor" class="absolute top-0 bottom-0 bg-indigo-600/20 border-x-2 border-indigo-600 z-10 pointer-events-none">
                    <div class="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded-full shadow-lg -top-3 absolute font-bold whitespace-nowrap left-1/2 -translate-x-1/2">Meeting Window</div>
                </div>
            </div>

            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-5 rounded-2xl bg-indigo-50/50 border border-indigo-100">
                    <span class="block text-[10px] font-bold text-indigo-400 uppercase mb-2">Your Date & Time</span>
                    <div id="myDisplayTime" class="text-2xl font-black text-indigo-700 leading-tight">--</div>
                    <div id="myDisplayDate" class="text-sm font-bold text-indigo-600 mt-1">--</div>
                </div>
                <div class="flex items-center justify-center">
                    <div id="statusCard" class="flex flex-col items-center p-4 px-8 rounded-3xl border-2 transition-all shadow-sm">
                        <div id="statusIconContainer" class="p-1.5 rounded-full mb-2"></div>
                        <span id="statusText" class="font-black text-sm">--</span>
                    </div>
                </div>
                <div class="p-5 rounded-2xl bg-emerald-50/50 border border-emerald-100 text-right">
                    <span class="block text-[10px] font-bold text-emerald-400 uppercase mb-2">Their Date & Time</span>
                    <div id="otherDisplayTime" class="text-2xl font-black text-emerald-700 leading-tight">--</div>
                    <div id="otherDisplayDate" class="text-sm font-bold text-emerald-600 mt-1">--</div>
                </div>
            </div>
        </section>

        <!-- Suggestions -->
        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4 text-amber-500 fill-amber-500"></i>
                    <h3 class="font-bold text-slate-700">Smart Overlap Suggestions</h3>
                </div>
            </div>
            <div id="suggestionsList" class="divide-y divide-slate-100 max-h-64 overflow-y-auto custom-scrollbar">
                <!-- Suggestions will be injected here -->
            </div>
        </section>

        <button id="finalizeBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-5 rounded-2xl shadow-xl transition-all flex items-center justify-center gap-4 group">
            <div class="flex items-center gap-2">
                <i data-lucide="download" class="w-5 h-5 text-indigo-400 group-hover:scale-110 transition-transform"></i>
                <span class="border-r border-slate-700 pr-4">Save .ICS File</span>
            </div>
            <div class="flex items-center gap-2">
                <i data-lucide="copy" class="w-5 h-5 text-emerald-400 group-hover:scale-110 transition-transform"></i>
                <span>Copy Full Invite</span>
            </div>
        </button>

    </div>

    <script>
        // --- State Management ---
        const state = {
            selectedDate: new Date().toISOString().split('T')[0],
            myTz: Intl.DateTimeFormat().resolvedOptions().timeZone,
            otherTz: 'America/New_York',
            startTime: 10,
            duration: 1,
            myWorkStart: 9,
            myWorkEnd: 17,
            otherWorkStart: 9,
            otherWorkEnd: 17,
            isDragging: false
        };

        // --- Helpers ---
        function getOffset(tz) {
            try {
                const date = new Date();
                const utcDate = new Date(date.toLocaleString('en-US', { timeZone: 'UTC' }));
                const tzDate = new Date(date.toLocaleString('en-US', { timeZone: tz }));
                return (tzDate.getTime() - utcDate.getTime()) / 3600000;
            } catch (e) { return 0; }
        }

        const isInsideRange = (hour, start, end) => {
            if (start < end) return hour >= start && hour < end;
            if (start > end) return hour >= start || hour < end;
            return hour === start;
        };

        const getHourLabel = (h) => {
            const period = h >= 12 ? 'PM' : 'AM';
            const displayHour = h % 12 === 0 ? 12 : h % 12;
            return `${displayHour} ${period}`;
        };

        const getSpecificDate = (baseDate, hourOffsetFromBase) => {
            const date = new Date(baseDate + 'T00:00:00');
            date.setHours(date.getHours() + hourOffsetFromBase);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            const dateStr = date.toLocaleDateString(undefined, options);
            const base = new Date(baseDate + 'T00:00:00');
            const diffDays = Math.floor((date.setHours(0,0,0,0) - base.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
            let relativeLabel = "";
            if (diffDays === 1) relativeLabel = " (Tomorrow)";
            if (diffDays === -1) relativeLabel = " (Yesterday)";
            if (diffDays !== 0 && diffDays !== 1 && diffDays !== -1) relativeLabel = ` (${diffDays > 0 ? '+' : ''}${diffDays} days)`;
            return { dateStr, relativeLabel };
        };

        // --- Initialization ---
        function initSelectors() {
            const tzList = Intl.supportedValuesOf('timeZone');
            const myTzSelect = document.getElementById('myTz');
            const otherTzSelect = document.getElementById('otherTz');
            
            tzList.forEach(tz => {
                const offset = getOffset(tz);
                const label = `${tz.replace(/_/g, ' ')} (UTC${offset >= 0 ? '+' : ''}${offset})`;
                const optMy = new Option(label, tz);
                const optOther = new Option(label, tz);
                myTzSelect.add(optMy);
                otherTzSelect.add(optOther);
            });

            myTzSelect.value = state.myTz;
            otherTzSelect.value = state.otherTz;

            const hourSelectors = ['myWorkStart', 'myWorkEnd', 'otherWorkStart', 'otherWorkEnd'];
            hourSelectors.forEach(id => {
                const el = document.getElementById(id);
                for (let i = 0; i < 24; i++) {
                    const label = (id.includes('Start') ? 'From ' : 'To ') + getHourLabel(i);
                    el.add(new Option(label, i));
                }
            });

            document.getElementById('myWorkStart').value = state.myWorkStart;
            document.getElementById('myWorkEnd').value = state.myWorkEnd;
            document.getElementById('otherWorkStart').value = state.otherWorkStart;
            document.getElementById('otherWorkEnd').value = state.otherWorkEnd;
            document.getElementById('datePicker').value = state.selectedDate;
        }

        // --- Core Logic & Rendering ---
        function updateUI() {
            const tzDiff = getOffset(state.otherTz) - getOffset(state.myTz);
            const otherStartTime = ((state.startTime + tzDiff) % 24 + 24) % 24;

            // 1. Timeline Grid
            const grid = document.getElementById('timelineGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const otherHour = ((i + tzDiff) % 24 + 24) % 24;
                const isMyWork = isInsideRange(i, state.myWorkStart, state.myWorkEnd);
                const isOtherWork = isInsideRange(otherHour, state.otherWorkStart, state.otherWorkEnd);
                
                const segment = document.createElement('div');
                segment.className = 'flex-1 border-r border-slate-200/50 relative last:border-0';
                
                segment.innerHTML = `
                    <div class="absolute top-0 h-1/3 w-full ${isMyWork ? 'bg-indigo-500/20' : ''}"></div>
                    <div class="absolute top-1/3 h-1/3 w-full ${isMyWork && isOtherWork ? 'bg-amber-400' : ''}"></div>
                    <div class="absolute top-2/3 h-1/3 w-full ${isOtherWork ? 'bg-emerald-500/20' : ''}"></div>
                    ${i % 3 === 0 ? `<span class="absolute -bottom-7 left-0 text-[10px] text-slate-400 font-bold">${getHourLabel(i)}</span>` : ''}
                `;
                grid.appendChild(segment);
            }

            // 2. Selection Cursor
            const cursor = document.getElementById('selectionCursor');
            cursor.style.left = `${(state.startTime / 24) * 100}%`;
            cursor.style.width = `${(state.duration / 24) * 100}%`;

            // 3. Local Time Displays
            const myDate = getSpecificDate(state.selectedDate, state.startTime);
            const otherDate = getSpecificDate(state.selectedDate, state.startTime + tzDiff);

            document.getElementById('myDisplayTime').innerText = getHourLabel(state.startTime);
            document.getElementById('myDisplayDate').innerText = myDate.dateStr + myDate.relativeLabel;
            document.getElementById('otherDisplayTime').innerText = getHourLabel(Math.floor(otherStartTime));
            document.getElementById('otherDisplayDate').innerText = otherDate.dateStr + otherDate.relativeLabel;

            // 4. Status Card
            const isOverlap = isInsideRange(state.startTime, state.myWorkStart, state.myWorkEnd) && 
                              isInsideRange(otherStartTime, state.otherWorkStart, state.otherWorkEnd);
            
            const card = document.getElementById('statusCard');
            const iconCont = document.getElementById('statusIconContainer');
            const text = document.getElementById('statusText');

            if (isOverlap) {
                card.className = "flex flex-col items-center p-4 px-8 rounded-3xl border-2 transition-all shadow-sm bg-emerald-50 border-emerald-200";
                iconCont.className = "bg-emerald-500 p-1.5 rounded-full mb-2";
                iconCont.innerHTML = '<i data-lucide="check-circle" class="text-white w-6 h-6"></i>';
                text.innerText = "PERFECT MATCH";
                text.className = "text-emerald-700 font-black text-sm";
            } else {
                card.className = "flex flex-col items-center p-4 px-8 rounded-3xl border-2 transition-all shadow-sm bg-amber-50 border-amber-200";
                iconCont.className = "bg-amber-500 p-1.5 rounded-full mb-2";
                iconCont.innerHTML = '<i data-lucide="alert-circle" class="text-white w-6 h-6"></i>';
                text.innerText = "OFF-HOURS";
                text.className = "text-amber-700 font-black text-sm";
            }

            // 5. Suggestions
            const list = document.getElementById('suggestionsList');
            list.innerHTML = '';
            let count = 0;
            for (let i = 0; i < 24; i++) {
                const oH = ((i + tzDiff) % 24 + 24) % 24;
                if (isInsideRange(i, state.myWorkStart, state.myWorkEnd) && isInsideRange(oH, state.otherWorkStart, state.otherWorkEnd)) {
                    count++;
                    const sD = getSpecificDate(state.selectedDate, i + tzDiff);
                    const item = document.createElement('div');
                    item.className = "p-4 flex items-center justify-between hover:bg-amber-50/50 cursor-pointer group";
                    item.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="bg-amber-100 text-amber-700 w-10 h-10 rounded-xl flex items-center justify-center font-black text-sm">${count}</div>
                            <div>
                                <div class="font-bold text-slate-800">${getHourLabel(i)} <span class="text-slate-400 font-normal mx-1">â†’</span> ${getHourLabel(Math.floor(oH))}</div>
                                <div class="text-[11px] text-amber-600 font-bold uppercase tracking-tight">Them: ${sD.dateStr}${sD.relativeLabel}</div>
                            </div>
                        </div>
                        <button class="opacity-0 group-hover:opacity-100 transition-opacity bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Select</button>
                    `;
                    item.onclick = () => { state.startTime = i; updateUI(); };
                    list.appendChild(item);
                }
            }
            if (count === 0) {
                list.innerHTML = '<div class="p-12 text-center text-slate-400 italic text-sm">No standard working overlap found.</div>';
            }

            lucide.createIcons();
        }

        // --- Drag Handlers ---
        const timeline = document.getElementById('timeline');
        const handleDrag = (e) => {
            const rect = timeline.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, x / rect.width));
            state.startTime = Math.floor(percentage * 24);
            updateUI();
        };

        timeline.addEventListener('mousedown', (e) => { state.isDragging = true; handleDrag(e); });
        window.addEventListener('mousemove', (e) => { if (state.isDragging) handleDrag(e); });
        window.addEventListener('mouseup', () => { state.isDragging = false; });
        
        timeline.addEventListener('touchstart', (e) => { state.isDragging = true; handleDrag(e); });
        window.addEventListener('touchmove', (e) => { if (state.isDragging) handleDrag(e); });
        window.addEventListener('touchend', () => { state.isDragging = false; });

        // --- Event Listeners ---
        document.getElementById('datePicker').addEventListener('change', (e) => { state.selectedDate = e.target.value; updateUI(); });
        document.getElementById('myTz').addEventListener('change', (e) => { state.myTz = e.target.value; updateUI(); });
        document.getElementById('otherTz').addEventListener('change', (e) => { state.otherTz = e.target.value; updateUI(); });
        document.getElementById('myWorkStart').addEventListener('change', (e) => { state.myWorkStart = parseInt(e.target.value); updateUI(); });
        document.getElementById('myWorkEnd').addEventListener('change', (e) => { state.myWorkEnd = parseInt(e.target.value); updateUI(); });
        document.getElementById('otherWorkStart').addEventListener('change', (e) => { state.otherWorkStart = parseInt(e.target.value); updateUI(); });
        document.getElementById('otherWorkEnd').addEventListener('change', (e) => { state.otherWorkEnd = parseInt(e.target.value); updateUI(); });

        // --- Finalize: Download & Copy ---
        document.getElementById('finalizeBtn').addEventListener('click', () => {
            const tzDiff = getOffset(state.otherTz) - getOffset(state.myTz);
            const oStartTime = ((state.startTime + tzDiff) % 24 + 24) % 24;
            
            const myD = getSpecificDate(state.selectedDate, state.startTime);
            const oD = getSpecificDate(state.selectedDate, state.startTime + tzDiff);
            const myTzLabel = state.myTz.split('/').pop().replace(/_/g, ' ');
            const oTzLabel = state.otherTz.split('/').pop().replace(/_/g, ' ');

            // 1. Generate ICS
            const startObj = new Date(state.selectedDate + 'T00:00:00');
            startObj.setHours(startObj.getHours() + state.startTime - getOffset(state.myTz));
            const endObj = new Date(startObj.getTime() + state.duration * 3600000);
            const formatICS = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'BEGIN:VEVENT',
                `DTSTART:${formatICS(startObj)}`,
                `DTEND:${formatICS(endObj)}`,
                'SUMMARY:SyncLink Meeting',
                `DESCRIPTION:Scheduled via SyncLink.\n\nYou: ${getHourLabel(state.startTime)} ${myD.dateStr}\n\nThem: ${getHourLabel(Math.floor(oStartTime))} ${oD.dateStr}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = 'sync_meeting.ics';
            link.click();

            // 2. Copy Invite
            const inviteMsg = `Hi! Let's meet.\n\n` +
                `Proposed Times:\n` +
                `- YOU: ${getHourLabel(state.startTime)}, ${myD.dateStr}${myD.relativeLabel} (${myTzLabel})\n` +
                `- THEM: ${getHourLabel(Math.floor(oStartTime))}, ${oD.dateStr}${oD.relativeLabel} (${oTzLabel})\n\n` +
                `Looking forward to it! (Sent via SyncLink)`;

            const textArea = document.createElement("textarea");
            textArea.value = inviteMsg;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            // Toast
            const toast = document.getElementById('successToast');
            toast.classList.remove('hidden');
            toast.classList.add('animate-success');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('animate-success');
            }, 3000);
        });

        // --- Start ---
        initSelectors();
        updateUI();
    </script>
</body>
</html>
